<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagmaSender App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .greyed-out {
            opacity: 0.5;
            pointer-events: none;
        }
        .active, .connect-btn {
            opacity: 1;
            pointer-events: auto;
        }
        #walletInfo, #tokenApproval, #tokenTransfer, .connect-btn {
            margin-top: 20px;
        }
        input, button {
            margin-top: 10px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            cursor: pointer;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
<body>
    <button class="connect-btn" onclick="connectWallet()">Connect Wallet</button>

    <div id="app" class="greyed-out">
        <div id="walletInfo">
            <p id="walletConnected">Wallet Connected: <span id="userAddress">No</span></p>
        </div>
        <div id="tokenApproval">
            <input type="text" id="tokenContractAddress" placeholder="Token Contract Address">
            <input type="number" id="approvalAmount" placeholder="Approval Amount">
            <button onclick="approveToken()">Approve Token</button>
        </div>
    </div>

    <script>
        const ERC20_ABI = [{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}];

        console.log('Script started');

        const app = document.getElementById('app');
        const connectBtn = document.querySelector('.connect-btn');
        const userAddressSpan = document.getElementById('userAddress');
        const tokenContractAddressInput = document.getElementById('tokenContractAddress');
        const approvalAmountInput = document.getElementById('approvalAmount');
        const senderContractAddress = "0xc10685ff28e298e72ce3cc7c7ef3306de685326a";

        console.log('Variables set');

        if (typeof window.ethereum !== 'undefined') {
            console.log('MetaMask is available!');
        } else {
            console.log('MetaMask not available. Please install it.');
        }

        async function connectWallet() {
            console.log('Attempting to connect wallet');
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Accounts received:', accounts);
                const account = accounts[0];
                app.classList.remove('greyed-out');
                app.classList.add('active');
                connectBtn.classList.add('greyed-out');
                userAddressSpan.parentNode.textContent = `Wallet Connected: ${account}`;
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
            }
        }

        async function approveToken() {
            console.log('Approve token clicked');
            const tokenContractAddress = tokenContractAddressInput.value.trim();
            const approvalAmount = approvalAmountInput.value.trim();
            console.log(`Approving token: ${tokenContractAddress} with amount: ${approvalAmount}`);

            if (!tokenContractAddress || !approvalAmount) {
                console.log("Token contract address and approval amount are required.");
                alert("Token contract address and approval amount are required.");
                return;
            }

            try {
                const web3 = new Web3(window.ethereum);
                console.log('Web3 initialized');
                const tokenContract = new web3.eth.Contract(ERC20_ABI, tokenContractAddress);
                console.log('Token contract instantiated', tokenContract);
                const accounts = await web3.eth.getAccounts();
                console.log('Accounts received for approval:', accounts);
                const account = accounts[0];

                // Convert the amount to Wei if needed
                const amountInWei = web3.utils.toWei(approvalAmount, 'ether');
                console.log(`Converted amount in Wei: ${amountInWei}`);

                const result = await tokenContract.methods.approve(senderContractAddress, amountInWei).send({ from: account });
                console.log("Token approval successful:", result);
                alert("Token approval successful.");
            } catch (error) {
                console.error('Error in token approval:', error);
                alert("Token approval failed: " + error.message);
            }
        }
    </script>
</body>
</html>
